<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon_32.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
    <link rel="manifest" href="/images/site.webmanifest">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>ELF64 hello world | tuket</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="/css/syntax.css" />
    
    <header>

  <nav>
    <ul>
      
      
      <li class="pull-left ">
        
        <a href="https://tuket.github.io">~/<img src="/img/tuket_alpha_icon.png" width=18 style="vertical-align:-5px;"></a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/posts/">~/posts</a>
      </li>
      
      
      <li class="pull-left current">
        <a href="/notes/">~/notes</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/portfolio/">~/portfolio</a>
      </li>
      

      
      
      <li class="pull-right">
        <a href="/index.xml">~/rss</a>
      </li>
      

    </ul>
  </nav>
</header>

  </head>

  <body>
    
        
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>


<script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI"
crossorigin="anonymous"
onload='renderMathInElement(document.body);'></script>


<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    });
</script>

<a href="../">&lt;&lt; ../</a>
<div class="article-meta">
<h1><span class="title">ELF64 hello world</span></h1>
</div>


<div class="content-wrapper">
  <main>
    <p>Work in progress&hellip;</p>
<p>I like to understand how things work under the hood. Assembly programming is very close to the metal but, even then, the assembler hides some complexity to make our lives easier. Also the linker does lots of work I don&rsquo;t completely understand.</p>
<p>So I though I would make an executable by hand, where every bit in it is understood. The resulting ELF64 executable is very small (160 bytes) compared with the executables generated by C compilers and even assemblers.</p>
<p>I found the <a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">wikepedia article</a> on the ELF format to be quite handy, although I also had to look up other resorces (all of them at the end).</p>
<p>The executable has only one program segment that contains both code and data. There are no sections. Segments and sections are different things<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</p>
<p>I also read <a href="https://www.muppetlabs.com/~breadbox/software/tiny/teensy.html">this article</a> about making the smallest possible ELF32 executable that returns 42. Lots of tricks are used in order to make the executable as small a possible, even some that abuse the ELF format spec, like overlapping different sections. We are not going to go as far, just try to make the simplest hello world. Also, I&rsquo;m going to make an ELF64 instead. There is also <a href="https://stackoverflow.com/questions/53382589/smallest-executable-program-x86-64">this post</a> in StackOverflow where they also try to make the smallest possible ELF64.</p>
<p>We could make our executable by typing it in a hex editor. But there are other more convenient ways.</p>
<p>In the resources just mentioned, they use NASM with a special flag <code>-f bin</code>. With this flag, only what is specified in the <code>.asm</code> source file will appear in the output binary file (when we compile normaly, NASM creates for you the ELF headers and so on). This is what one of this <code>.asm</code> files would look like (copied from the forementioned StackOverflow post):</p>
<div class="highlight"><pre class="chroma"><code class="language-nasm" data-lang="nasm"><span class="k">bits</span> <span class="mi">64</span>
<span class="k">org</span> <span class="mh">0x08048000</span>

<span class="nl">ehdr:</span>                                     <span class="c1">; Elf64_Ehdr</span>
            <span class="kd">db</span>  <span class="mh">0x7F</span><span class="p">,</span> <span class="s">&#34;ELF&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>   <span class="c1">;   e_ident</span>
    <span class="kd">times</span> <span class="mi">8</span> <span class="nv">db</span>  <span class="mi">0</span>
            <span class="kd">dw</span>  <span class="mi">2</span>                         <span class="c1">;   e_type</span>
            <span class="kd">dw</span>  <span class="mi">62</span>                        <span class="c1">;   e_machine</span>
            <span class="kd">dd</span>  <span class="mi">1</span>                         <span class="c1">;   e_version</span>
            <span class="kd">dq</span>  <span class="nv">_start</span>                    <span class="c1">;   e_entry</span>
            <span class="kd">dq</span>  <span class="nv">phdr</span> <span class="o">-</span> <span class="kc">$$</span>                 <span class="c1">;   e_phoff</span>
            <span class="kd">dq</span>  <span class="mi">0</span>                         <span class="c1">;   e_shoff</span>
            <span class="kd">dd</span>  <span class="mi">0</span>                         <span class="c1">;   e_flags</span>
            <span class="kd">dw</span>  <span class="nv">ehdrsize</span>                  <span class="c1">;   e_ehsize</span>
            <span class="kd">dw</span>  <span class="nv">phdrsize</span>                  <span class="c1">;   e_phentsize</span>
            <span class="kd">dw</span>  <span class="mi">1</span>                         <span class="c1">;   e_phnum</span>
            <span class="kd">dw</span>  <span class="mi">0</span>                         <span class="c1">;   e_shentsize</span>
            <span class="kd">dw</span>  <span class="mi">0</span>                         <span class="c1">;   e_shnum</span>
            <span class="kd">dw</span>  <span class="mi">0</span>                         <span class="c1">;   e_shstrndx</span>

<span class="no">ehdrsize</span><span class="kd">    equ</span> <span class="kc">$</span> <span class="o">-</span> <span class="nv">ehdr</span>

<span class="nl">phdr:</span>                                     <span class="c1">; Elf64_Phdr</span>
            <span class="kd">dd</span>  <span class="mi">1</span>                         <span class="c1">;   p_type</span>
            <span class="kd">dd</span>  <span class="mi">7</span>                         <span class="c1">;   p_flags</span>
            <span class="kd">dq</span>  <span class="mi">0</span>                         <span class="c1">;   p_offset</span>
            <span class="kd">dq</span>  <span class="kc">$$</span>                        <span class="c1">;   p_vaddr</span>
            <span class="kd">dq</span>  <span class="kc">$$</span>                        <span class="c1">;   p_paddr</span>
            <span class="kd">dq</span>  <span class="nv">filesize</span>                  <span class="c1">;   p_filesz</span>
            <span class="kd">dq</span>  <span class="nv">filesize</span>                  <span class="c1">;   p_memsz</span>
            <span class="kd">dq</span>  <span class="mh">0x1000</span>                    <span class="c1">;   p_align</span>

<span class="no">phdrsize</span><span class="kd">    equ</span>     <span class="kc">$</span> <span class="o">-</span> <span class="nv">phdr</span>

<span class="nl">_start:</span>
   <span class="nf">mov</span> <span class="nb">di</span><span class="p">,</span><span class="mi">42</span>        <span class="c1">; only the low byte of the exit code is kept,</span>
                    <span class="c1">; so we can use di instead of the full edi/rdi</span>
   <span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span><span class="nb">eax</span>
   <span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span><span class="mi">60</span>        <span class="c1">; shorter than mov eax,60</span>
   <span class="nf">syscall</span>          <span class="c1">; perform the syscall</span>

<span class="no">filesize</span><span class="kd">      equ</span>     <span class="kc">$</span> <span class="o">-</span> <span class="kc">$$</span>
</code></pre></div><p>And we can compile it with:</p>
<pre><code>nasm -f bin min64.asm -o min64
</code></pre><p>But instead of using NASM for generating the executable, I opted to use a small C program that writes a binary file. Because in the future I want to make a compiler in C that doesn&rsquo;t require an assembler.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">typedef</span> <span class="n">uint8_t</span> <span class="n">u8</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">uint16_t</span> <span class="n">u16</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">uint32_t</span> <span class="n">u32</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">uint64_t</span> <span class="n">u64</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">Elf64Header</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">elfMagicNumber</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// &#34;\x7fELF&#34;
</span><span class="c1"></span>    <span class="n">u8</span> <span class="n">bitAmount</span><span class="p">;</span> <span class="c1">// 1: 32-bit, 2: 64-bit
</span><span class="c1"></span>    <span class="n">u8</span> <span class="n">endian</span><span class="p">;</span> <span class="c1">// 1: little endian, 2: big endian
</span><span class="c1"></span>    <span class="n">u8</span> <span class="n">elfVersion1</span><span class="p">;</span> <span class="c1">// must be 1
</span><span class="c1"></span>    <span class="n">u8</span> <span class="n">osAbi</span><span class="p">;</span> <span class="c1">// 0: System V, 3: Linux
</span><span class="c1"></span>    <span class="n">u8</span> <span class="n">abiVersion</span><span class="p">;</span> <span class="c1">// in statically linked executables has no effect. In dynamically linked executables, if OS_ABI==3, defines dynamic linker features
</span><span class="c1"></span>    <span class="n">u8</span> <span class="n">unused</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
    <span class="n">u16</span> <span class="n">objFileType</span><span class="p">;</span> <span class="c1">// ET_EXEC=2, ET_DYN=3 (DYN is used for PIC)
</span><span class="c1"></span>    <span class="n">u16</span> <span class="n">arch</span><span class="p">;</span> <span class="c1">// 0x3E: AMD64
</span><span class="c1"></span>    <span class="n">u32</span> <span class="n">elfVersion2</span><span class="p">;</span> <span class="c1">// the elf version again, must be 1
</span><span class="c1"></span>    <span class="n">u64</span> <span class="n">entryPointOffset</span><span class="p">;</span> <span class="c1">// entry point from where the process should start executing
</span><span class="c1"></span>    <span class="n">u64</span> <span class="n">phtOffset</span><span class="p">;</span> <span class="c1">// start of the program header table
</span><span class="c1"></span>    <span class="n">u64</span> <span class="n">shtOffset</span><span class="p">;</span> <span class="c1">// start of the section header table
</span><span class="c1"></span>    <span class="n">u32</span> <span class="n">processorFlags</span><span class="p">;</span> <span class="c1">// processor-specific flags
</span><span class="c1"></span>    <span class="n">u16</span> <span class="n">headerSize</span><span class="p">;</span> <span class="c1">// the size of this header
</span><span class="c1"></span>    <span class="n">u16</span> <span class="n">phtEntrySize</span><span class="p">;</span> <span class="c1">// the size of one PHT entry
</span><span class="c1"></span>    <span class="n">u16</span> <span class="n">numPhtEntries</span><span class="p">;</span> <span class="c1">// num entries in the PHT
</span><span class="c1"></span>    <span class="n">u16</span> <span class="n">shtEntrySize</span><span class="p">;</span> <span class="c1">// the size of one SHT entry
</span><span class="c1"></span>    <span class="n">u16</span> <span class="n">numShtEntries</span><span class="p">;</span> <span class="c1">// num entries in the SHT
</span><span class="c1"></span>    <span class="n">u16</span> <span class="n">namesSht</span><span class="p">;</span> <span class="c1">// the index of the SHT entry that contains the section names
</span><span class="c1"></span><span class="p">}</span> <span class="n">Elf64Header</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">Elf64_PhtEntry</span> <span class="p">{</span>
    <span class="n">u32</span> <span class="n">segmentType</span><span class="p">;</span> <span class="c1">// 1: loadable segment, 2: dynamic linking info
</span><span class="c1"></span>    <span class="n">u32</span> <span class="n">flags</span><span class="p">;</span> <span class="c1">// segment-dependent flags (position for 64-bit structure)
</span><span class="c1"></span>    <span class="n">u64</span> <span class="n">offset</span><span class="p">;</span> <span class="c1">// offset of the segment in the file image
</span><span class="c1"></span>    <span class="n">u64</span> <span class="n">vaddr</span><span class="p">;</span> <span class="c1">// virtual address of the segment in memory
</span><span class="c1"></span>    <span class="n">u64</span> <span class="n">paddr</span><span class="p">;</span> <span class="c1">// on systems where the physical address is relevant, reserved for the physical address of the segment
</span><span class="c1"></span>    <span class="n">u64</span> <span class="n">sizeInFile</span><span class="p">;</span> <span class="c1">// size of the segment in the file image
</span><span class="c1"></span>    <span class="n">u64</span> <span class="n">sizeInMem</span><span class="p">;</span> <span class="c1">// size of the segment in memory
</span><span class="c1"></span>    <span class="n">u64</span> <span class="n">align</span><span class="p">;</span> <span class="c1">// 0 and 1 specify no alignment. Otherwise should be a positive, integral power of 2, with &#39;vaddr&#39; equating &#39;offset&#39; modulus &#39;p_align&#39;
</span><span class="c1"></span><span class="p">}</span> <span class="n">Elf64_PhtEntry</span><span class="p">;</span>

<span class="c1">// https://godbolt.org/z/vh8aEe
</span><span class="c1"></span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">asmCode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// mov rax, 1 (syscall: write)
</span><span class="c1"></span>    <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// mov rdi, 1 (stdout)
</span><span class="c1"></span>    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="c1">// lea rsi, [rel helloStr]
</span><span class="c1"></span>    <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// mov rex, sizeof(helloStr)
</span><span class="c1"></span>    <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="c1">// syscall
</span><span class="c1"></span>    <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="c1">// mov eax, 3c
</span><span class="c1"></span>    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="c1">// xor rdi, rdi
</span><span class="c1"></span>    <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x05</span> <span class="c1">// syscall
</span><span class="c1"></span><span class="p">};</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">helloStr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="sc">&#39;h&#39;</span><span class="p">,</span> <span class="sc">&#39;e&#39;</span><span class="p">,</span> <span class="sc">&#39;l&#39;</span><span class="p">,</span> <span class="sc">&#39;l&#39;</span><span class="p">,</span> <span class="sc">&#39;o&#39;</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">headersSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf64Header</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf64_PhtEntry</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">fileSize</span> <span class="o">=</span> <span class="n">headersSize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">asmCode</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">helloStr</span><span class="p">);</span>

    <span class="n">Elf64Header</span> <span class="n">header</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">elfMagicNumber</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x7F</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">},</span>
        <span class="p">.</span><span class="n">bitAmount</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="c1">// 64-bit
</span><span class="c1"></span>        <span class="p">.</span><span class="n">endian</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// little endian
</span><span class="c1"></span>        <span class="p">.</span><span class="n">elfVersion1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">osAbi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// system V
</span><span class="c1"></span>        <span class="p">.</span><span class="n">abiVersion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">.</span><span class="n">unused</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
        <span class="p">.</span><span class="n">objFileType</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="mh">0x3E</span><span class="p">,</span>
        <span class="p">.</span><span class="n">elfVersion2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">entryPointOffset</span> <span class="o">=</span> <span class="mh">0x08048000</span> <span class="o">+</span> <span class="n">headersSize</span><span class="p">,</span>
        <span class="p">.</span><span class="n">phtOffset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf64Header</span><span class="p">),</span>
        <span class="p">.</span><span class="n">shtOffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">.</span><span class="n">processorFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">.</span><span class="n">headerSize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
        <span class="p">.</span><span class="n">phtEntrySize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf64_PhtEntry</span><span class="p">),</span>
        <span class="p">.</span><span class="n">numPhtEntries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">shtEntrySize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">.</span><span class="n">numShtEntries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">//1,
</span><span class="c1"></span>        <span class="p">.</span><span class="n">namesSht</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">};</span>

    <span class="n">Elf64_PhtEntry</span> <span class="n">phtEntry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">segmentType</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// 1: PT_LOAD
</span><span class="c1"></span>        <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">,</span> <span class="c1">// 0: execute, 1: write, 2: read
</span><span class="c1"></span>        <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="c1">// this one is quite weird. It looks like the entire executable need to be inside
</span><span class="c1"></span>            <span class="c1">// some segment, including the Elf64Header
</span><span class="c1"></span>        <span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="mh">0x8048000</span><span class="p">,</span> <span class="c1">// linux 
</span><span class="c1"></span>        <span class="p">.</span><span class="n">paddr</span> <span class="o">=</span> <span class="mh">0x8048000</span><span class="p">,</span>
        <span class="p">.</span><span class="n">sizeInFile</span> <span class="o">=</span> <span class="n">fileSize</span><span class="p">,</span>
        <span class="p">.</span><span class="n">sizeInMem</span> <span class="o">=</span> <span class="n">fileSize</span><span class="p">,</span>
        <span class="p">.</span><span class="n">align</span> <span class="o">=</span> <span class="mh">0x1000</span>
    <span class="p">};</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf64Header</span><span class="p">));</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%ld</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf64_PhtEntry</span><span class="p">));</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">fileSize</span><span class="o">-</span><span class="mi">7</span><span class="p">);</span>

    <span class="n">FILE</span><span class="o">*</span> <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;raw_exe&#34;</span><span class="p">,</span> <span class="s">&#34;w&#34;</span><span class="p">);</span>

    <span class="n">fwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="p">),</span> <span class="n">file</span><span class="p">);</span>
    <span class="n">fwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phtEntry</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phtEntry</span><span class="p">),</span> <span class="n">file</span><span class="p">);</span>
    <span class="n">fwrite</span><span class="p">(</span><span class="n">asmCode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">asmCode</span><span class="p">),</span> <span class="n">file</span><span class="p">);</span>
    <span class="n">fwrite</span><span class="p">(</span><span class="n">helloStr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">helloStr</span><span class="p">),</span> <span class="n">file</span><span class="p">);</span>

    <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>Inside the <a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format#Program_header">Program header</a>, I struggled a lot with the <code>p_offset</code> field (<a href="https://cirosantilli.com/elf-hello-world#p-191">and I&rsquo;m not the only one</a>). If you didn&rsquo;t notice, the value of <code>p_offset</code> is 0. But the <a href="https://refspecs.linuxbase.org/elf/gabi4+/ch5.pheader.html">spec</a> says:</p>
<blockquote>
<p>This member gives the offset from the beginning of the file at which the first byte of the segment resides</p>
</blockquote>
<p>And our executable layout looks like this:</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Elf64Header</td>
<td style="text-align:left">64 bytes</td>
</tr>
<tr>
<td style="text-align:left">Program Header Entry</td>
<td style="text-align:left">56 bytes</td>
</tr>
<tr>
<td style="text-align:left">Program Segment</td>
<td style="text-align:left">&hellip;</td>
</tr>
</tbody>
</table>
<p>So shouldn&rsquo;t <code>p_offset</code> be 64+56=120?</p>
<p>That would make sense but that&rsquo;s not how it works. The Linux executable loader, only loads to memory the segments as they are specified. That means, data that doesn&rsquo;t belong to a segment, is not loaded. Therefore, the ELF header and the Program Header Table, as they also need to be loaded to memory, need to be within the range of one segment. And, since we only have one segment, that segment must cover the whole file! I haven&rsquo;t been able to find any official resource to verify this claim, but here are some resources that mention it:</p>
<ul>
<li><a href="https://www.intezer.com/blog/research/executable-linkable-format-101-part1-sections-segments/">https://www.intezer.com/blog/research/executable-linkable-format-101-part1-sections-segments/</a></li>
<li><a href="http://michalmalik.github.io/elf-dynamic-segment-struggles">http://michalmalik.github.io/elf-dynamic-segment-struggles</a></li>
<li><a href="https://jeffjerseycow.github.io/2017/12/what-are-the-got-and-plt-pt1">https://jeffjerseycow.github.io/2017/12/what-are-the-got-and-plt-pt1</a></li>
<li><a href="https://forum.osdev.org/viewtopic.php?f=1&amp;t=39005">https://forum.osdev.org/viewtopic.php?f=1&amp;t=39005</a></li>
<li><a href="http://www.048227799.com/upload/Files/Rise%20&amp;%20Fall%20of%20Binaries%20-%20Part%2003.pdf">http://www.048227799.com/upload/Files/Rise%20&amp;%20Fall%20of%20Binaries%20-%20Part%2003.pdf</a></li>
</ul>
<p>Other intersting resources:</p>
<ul>
<li><a href="https://greek0.net/elf.html">https://greek0.net/elf.html</a></li>
<li><a href="https://stackoverflow.com/questions/2966426/why-do-virtual-memory-addresses-for-linux-binaries-start-at-0x8048000">https://stackoverflow.com/questions/2966426/why-do-virtual-memory-addresses-for-linux-binaries-start-at-0x8048000</a></li>
<li><a href="https://docs.oracle.com/cd/E19683-01/816-1386/6m7qcoblk/index.html#chapter6-tbl-39">https://docs.oracle.com/cd/E19683-01/816-1386/6m7qcoblk/index.html#chapter6-tbl-39</a></li>
</ul>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://stackoverflow.com/questions/14361248/whats-the-difference-of-section-and-segment-in-elf-file-format">https://stackoverflow.com/questions/14361248/whats-the-difference-of-section-and-segment-in-elf-file-format</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p><a href="https://cirosantilli.com/elf-hello-world#section-vs-segment">https://cirosantilli.com/elf-hello-world#section-vs-segment</a> <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    <a href="/"> >> Home</a>
  </main>
</div>
    <footer>
      
<script>
(function() {
  function center_el(tagName) {
    var tags = document.getElementsByTagName(tagName), i, tag;
    for (i = 0; i < tags.length; i++) {
      tag = tags[i];
      var parent = tag.parentElement;
      
      if (parent.childNodes.length === 1) {
        
        if (parent.nodeName === 'A') {
          parent = parent.parentElement;
          if (parent.childNodes.length != 1) continue;
        }
        if (parent.nodeName === 'P') parent.style.textAlign = 'center';
      }
    }
  }
  var tagNames = ['img', 'embed', 'object'];
  for (var i = 0; i < tagNames.length; i++) {
    center_el(tagNames[i]);
  }
})();
</script>

      
      <hr/>
      <a href="https://github.com/tuket"><img src="/img/github_icon.svg" width="18" height="18" alt="github"></a> <a href="https://stackoverflow.com/users/1754322/tuket"><img src="/img/stack_overflow_icon.svg" width="18" height="18" alt="stackOverflow"></a> <a href="https://www.linkedin.com/in/tuket/"><img src="/img/linkedin_icon.svg" width="18" height="18" alt="linkedin"></a> <a href="mailto:tuket.webpage.0@gmail.com"><img src="/img/email_icon.svg" width="18" height="18" alt="email"></a>
      
    </footer>
    
  </body>
</html>

